# jvm

## 1、jvm参数

### 标准参数

只有一个：-

```
-version 
-help 
-server 
-cp
```

## -X参数

非标准参数，也就是在jdk各个版本中可能会变动

```
-Xint 解释执行
-Xcomp 第一次使用就编译成本地代码
-Xmixed 混合模式
-X:loggc:log/gc.log 生成gc日志
```

### -XX参数

这个参数是最常用的。

**主要用于JVM调优和Debug**

```
-Xms 1000 == -XX:InitialHeapSize=1000
// 设置初始堆大小

-Xmx 1000 == -XX:MaxHeapSize=1000
// 设置最大的堆大小

-Xss1000 ==  -XX:ThreadStackSize=100
// 设置每个线程的堆栈大小（这个一般不管他）

-Xmn100
// 设置年轻代大小

-XX:NewRatio=2
-XX:SurvivorRatio=8
// 表示Eden和service的比率是2/8

-XX:PermSize=100M
// 表示设置永久代的内存大小

-XX:MaxPermSize=100M 
// 表示设置永久代最大的内存大小

// 不过jdk1.8之后会永久代被移除了，使用下面的参数来配置
-XX:MetaspaceSize=100M  
-XX:MaxMetaspaceSize=100M 

-XX:MaxTenuringThreshold=15
// 设置经过15次YGC依然存活的对象，放到老年代里面


-XX:+printGC
-XX:+PrintGCDetails
// 打印GC信息

-XX:+HeapDumpOnOutOfMemoryError	
// 让jvm溢出时dump出内存快照，以便分析使用（生产环境必配）

-XX:+PrintCommandLineFlags -version
// 打印默认的参数



```



## 2、jvm调优思路

### 2.1 工具

**top指令**：查看当前所有进程的使用情况，CPU占有率，内存使用情况，服务器负载状态等参数。除此之外它还是个交互命令，使用可参考[完全解读top](https://zhuanlan.zhihu.com/p/36995443)。
**jps**：与linux上的ps类似，用于查看有权访问的虚拟机的进程，可以查看本地运行着几个java程序，并显示他们的进程号。当未指定hostid时，默认查看本机jvm进程。
**jinfo**：可以输出并修改运行时的java 进程的一些参数。
**jstat**：可以用来监视jvm内存内的各种堆和非堆的大小及其内存使用量。
**jstack**：堆栈跟踪工具，一般用于查看某个进程包含线程的情况。
**jmap：**打印出某个java进程（使用pid）内存内的所有对象的情况。一般用于查看内存占用情况。
**jconsole**：一个java GUI监视工具，可以以图表化的形式显示各种数据。并可通过远程连接监视远程的服务器的jvm进程。

### 2.2 步骤

#### 1、监控GC的状态

后面在补上。。。。。。。。。。。。

## 3、jvm调优实战课程笔记

### （一）背景说明

#### 生产环境中的问题

1. 内存溢出
2. 服务器分配多少内存
3. 如何对辣鸡收集器的性能进行调优
4. 生成环境的CPU负载飙高如何处理
5. 生产环境应该分配多少线程合适
6. 不加log，如何确定请求是否执行了某一行的代码
7. 不加log，如何实时查看某个方法的入参和返回值

#### 为什么要调优？

1. 防止OOM
2. 解决OOM（报警系统）
3. 减少Full GC出现的频率（用户反馈）

#### 不同阶段的考虑

1. 上线前（测试的时候）
2. 项目运行阶段（监控环境）
3. 线上出现OOM

### （二）调优概述

#### 监控的依据

1. 运行日志
2. 异常堆栈
3. GC日志
4. 线程快照
5. 堆转储快照（dump)

#### 调优大方向

1. 合理编写代码
2. 充分并合理的使用硬件资源
3. 合理地进行jvm调优

### （三）性能优化的步骤

#### 性能监控

**无监控不调优。注意需要非强行或入侵的方式来收集或查看应用的性能数据**

1. GC频繁
2. cpu load过高
3. OOM
4. 内存泄漏
5. 死锁
6. 程序响应时间长

#### 性能分析

一般是在测试环境来做的。

- 打印GC日志，通过GCview或者GC easy来分析日志信息
- 命令行工具，jstack，jmap，jinfo等
- dump出堆文件，使用内存分析工具来分析文件
- 使用arhtas或者jconsole，jvisualvm来实时查看
- jstack查看堆栈信息

#### 性能调优

- 适当增加内存，根据业务选择辣鸡回收器
- 优化代码
- 增加机器，分散节点压力
- 合理设置线程池数量
- 使用中间件提高程序效率
- 其他---

### （四）性能评价/测试指标

1. **停顿时间（或响应时间）**

   一般关注平均响应时间

2. **吞吐量**

3. 并发数

4. 内存占用

5. 相互间的关系

### （五）JVM监控及诊断工具-命令行篇

#### 概述

使用数据说明问题，使用知识分析问题，使用工具处理问题

无监控、不调优！

#### jps

查看正在运行的java进程

#### jstat



#### jinfo

#### jmap

#### jhat

#### jstack
